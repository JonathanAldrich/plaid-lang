package plaid.typechecker.lnf.tests;

import plaid.ast.*;
import plaid.ast.visitor.*;
import plaid.testing.*;
import java.lang.System;
import plaid.typechecker.context.*;
import plaid.ast.stateTable.*;
import plaid.typechecker.lnf.*;
import plaid.ast.types.permissions.*;

val varTests = fn(unique Tester tester) => {
	var newAst = unit;
	var oldAst = unit;
	var goalAst = unit;
	val unique LetNormalFormVisitor lnfVisitor = new LetNormalFormVisitor;
	
	System.out.println("Testing Variable transformation");
	testName("lnf-var");
	oldAst = makeID(makeToken(),"x");
	newAst = oldAst.accept(lnfVisitor).first();
	goalAst = makeTake(makeToken(),makeTempID(makeToken(),"t1"),makeID(makeToken(),"x"),
					   makeTempID(makeToken(),"t1"), false);
	match (newAst == goalAst) {
		case True {
			tester.testPassed(true);
		}
		case False {
			tester.testPassed(false);
			printErrorASTs(oldAst,newAst,goalAst);
		}
	};
	
//	var typefether = new TypeFetchVisitor { var context = new Context; };
//	newAst.accept(typefether);
//	
//	var printer = new PrintVisitor;
//	newAst.accept(printer);
	
	//Object Type test
	val st = new StateTable;
	val ct = new Context; 
	
	val stType = st.get(makeID(makeToken(), "unit")).value;
	//ct.put(makeID(makeToken(), "x"), createPermType(IMM, createNominalType(makeID(makeToken(), "unit"))));
	//ct.put(makeID(makeToken(), "x"), createNominalType(makeID(makeToken(), "unit")));
	putPerm(ct, "x", "unit");
	
	var typefetcher = new TypeFetchVisitor { var context = ct; var stateTable = st; };
	newAst.accept(typefetcher);
};